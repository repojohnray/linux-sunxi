// SPDX-License-Identifier: GPL-2.0
/*
 * Cedrus VPU driver
 *
 * Copyright (C) 2022 Emmanuel Gil Peyrot <linkmauve@linkmauve.fr>
 */

#include <media/videobuf2-dma-contig.h>
#include <media/v4l2-jpeg.h>

#include "cedrus.h"
#include "cedrus_hw.h"
#include "cedrus_regs.h"

static const uint16_t cedrus_jpeg_default_dht[] = {
	0x0000, 0x0000, 0x0002, 0x000e, 0x001e, 0x003e, 0x007e, 0x00fe,
	0x01fe, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff,
	0x0000, 0x0601, 0x0807, 0x0a09, 0x0c0b, 0x0c0c, 0x0c0c, 0x0c0c,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0004, 0x000a, 0x001a, 0x003a, 0x0078, 0x00f8,
	0x01f6, 0x03f6, 0x07f6, 0x0ff4, 0x1ff0, 0x3fe0, 0x7fc0, 0xff82,
	0x0000, 0x0302, 0x0906, 0x0f0b, 0x1712, 0x201c, 0x2424, 0x2524,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0006, 0x000e, 0x001e, 0x003e, 0x007e, 0x00fe,
	0x01fe, 0x03fe, 0x07fe, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff,
	0x0000, 0x0403, 0x0605, 0x0807, 0x0a09, 0x0c0b, 0x0c0c, 0x0c0c,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0004, 0x000a, 0x0018, 0x0038, 0x0078, 0x00f6,
	0x01f4, 0x03f6, 0x07f6, 0x0ff4, 0x1ff0, 0x3fe0, 0x7fc2, 0xff88,
	0x0000, 0x0302, 0x0905, 0x100d, 0x1b14, 0x2420, 0x2828, 0x2b29,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0100, 0x0302, 0x0504, 0x0706, 0x0908, 0x0b0a, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0201, 0x0003, 0x1104, 0x1205, 0x3121, 0x0641, 0x5113, 0x0761,
	0x7122, 0x3214, 0x9181, 0x08a1, 0x4223, 0xc1b1, 0x5215, 0xf0d1,
	0x3324, 0x7262, 0x0982, 0x160a, 0x1817, 0x1a19, 0x2625, 0x2827,
	0x2a29, 0x3534, 0x3736, 0x3938, 0x433a, 0x4544, 0x4746, 0x4948,
	0x534a, 0x5554, 0x5756, 0x5958, 0x635a, 0x6564, 0x6766, 0x6968,
	0x736a, 0x7574, 0x7776, 0x7978, 0x837a, 0x8584, 0x8786, 0x8988,
	0x928a, 0x9493, 0x9695, 0x9897, 0x9a99, 0xa3a2, 0xa5a4, 0xa7a6,
	0xa9a8, 0xb2aa, 0xb4b3, 0xb6b5, 0xb8b7, 0xbab9, 0xc3c2, 0xc5c4,
	0xc7c6, 0xc9c8, 0xd2ca, 0xd4d3, 0xd6d5, 0xd8d7, 0xdad9, 0xe2e1,
	0xe4e3, 0xe6e5, 0xe8e7, 0xeae9, 0xf2f1, 0xf4f3, 0xf6f5, 0xf8f7,
	0xfaf9, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0100, 0x0302, 0x0504, 0x0706, 0x0908, 0x0b0a, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0100, 0x0302, 0x0411, 0x2105, 0x0631, 0x4112, 0x0751, 0x7161,
	0x2213, 0x8132, 0x1408, 0x9142, 0xb1a1, 0x09c1, 0x3323, 0xf052,
	0x6215, 0xd172, 0x160a, 0x3424, 0x25e1, 0x17f1, 0x1918, 0x261a,
	0x2827, 0x2a29, 0x3635, 0x3837, 0x3a39, 0x4443, 0x4645, 0x4847,
	0x4a49, 0x5453, 0x5655, 0x5857, 0x5a59, 0x6463, 0x6665, 0x6867,
	0x6a69, 0x7473, 0x7675, 0x7877, 0x7a79, 0x8382, 0x8584, 0x8786,
	0x8988, 0x928a, 0x9493, 0x9695, 0x9897, 0x9a99, 0xa3a2, 0xa5a4,
	0xa7a6, 0xa9a8, 0xb2aa, 0xb4b3, 0xb6b5, 0xb8b7, 0xbab9, 0xc3c2,
	0xc5c4, 0xc7c6, 0xc9c8, 0xd2ca, 0xd4d3, 0xd6d5, 0xd8d7, 0xdad9,
	0xe3e2, 0xe5e4, 0xe7e6, 0xe9e8, 0xf2ea, 0xf4f3, 0xf6f5, 0xf8f7,
	0xfaf9, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
};

static enum cedrus_irq_status cedrus_jpeg_irq_status(struct cedrus_ctx *ctx)
{
	struct cedrus_dev *dev = ctx->dev;
	u32 reg;

	reg = cedrus_read(dev, VE_DEC_MPEG_STATUS);
	reg &= VE_DEC_MPEG_STATUS_CHECK_MASK;

	if (!reg)
		return CEDRUS_IRQ_NONE;

	if (reg & VE_DEC_MPEG_STATUS_CHECK_ERROR ||
	    !(reg & VE_DEC_MPEG_STATUS_SUCCESS))
		return CEDRUS_IRQ_ERROR;

	return CEDRUS_IRQ_OK;
}

static void cedrus_jpeg_irq_clear(struct cedrus_ctx *ctx)
{
	struct cedrus_dev *dev = ctx->dev;

	cedrus_write(dev, VE_DEC_MPEG_STATUS, VE_DEC_MPEG_STATUS_CHECK_MASK);
}

static void cedrus_jpeg_irq_disable(struct cedrus_ctx *ctx)
{
	struct cedrus_dev *dev = ctx->dev;
	u32 reg = cedrus_read(dev, VE_DEC_MPEG_CTRL);

	reg &= ~VE_DEC_MPEG_CTRL_IRQ_MASK;

	cedrus_write(dev, VE_DEC_MPEG_CTRL, reg);
}

static void cedrus_write_table_header(struct cedrus_dev *dev,
				      struct v4l2_jpeg_reference *table)
{
	u16 start_codes[16], code;
	u8 offsets[16], *ptr;
	unsigned int count;
	u32 *ptr32;
	int i;

	count = 0;
	code = 0;
	ptr = &table->start[1];
	for (i = 0; i < 16; i++) {
		offsets[i] = count;
		start_codes[i] = code;
		count += ptr[i];
		code += ptr[i];
		code *= 2;
	}

	for (i = 15; i >= 0 && !ptr[i]; i--)
		start_codes[i] = 0xffff;

	ptr32 = (u32*)start_codes;
	for (i = 0; i < 8; i++)
		cedrus_write(dev, VE_DEC_MPEG_SRAM_RW_DATA, ptr32[i]);

	ptr32 = (u32*)offsets;
	for (i = 0; i < 4; i++)
		cedrus_write(dev, VE_DEC_MPEG_SRAM_RW_DATA, ptr32[i]);

	for (i = 0; i < 4; i++)
		cedrus_write(dev, VE_DEC_MPEG_SRAM_RW_DATA, 0);
}

static void cedrus_write_dh_tables(struct cedrus_dev *dev,
				   struct v4l2_jpeg_header *hdr)
{
	struct v4l2_jpeg_reference *tables[4], *table;
	struct v4l2_jpeg_scan_component_spec *comp;
	unsigned int i, j;
	size_t length;
	u32 *ptr, val;

	cedrus_write(dev, VE_DEC_MPEG_SRAM_RW_OFFSET, 0);

	if (!hdr->num_dht) {
		ptr = (u32*)cedrus_jpeg_default_dht;
		for (i = 0; i < sizeof(cedrus_jpeg_default_dht) / 4; i++)
			cedrus_write(dev, VE_DEC_MPEG_SRAM_RW_DATA, ptr[i]);
		return;
	}

	j = 0;
	for (i = 0; i < 2; i++) {
		comp = &hdr->scan->component[i];

		tables[j++] = &hdr->huffman_tables[comp->dc_entropy_coding_table_selector];
		tables[j++] = &hdr->huffman_tables[comp->ac_entropy_coding_table_selector + 2];
	}

	for (i = 0; i < 4; i++)
		cedrus_write_table_header(dev, tables[i]);

	for (i = 0; i < 192; i++)
		cedrus_write(dev, VE_DEC_MPEG_SRAM_RW_DATA, 0);

	for (i = 0; i < 4; i++) {
		table = tables[i];
		ptr = (u32*)&table->start[17];
		length = table->length - 17;

		for (j = 0; j < length / 4; j++)
			cedrus_write(dev, VE_DEC_MPEG_SRAM_RW_DATA, ptr[j]);

		if (length & 3) {
			val = 0;
			for (j = 0; j < (length & 3); j++)
				val = (val << 8) | table->start[16 + length - j];
			cedrus_write(dev, VE_DEC_MPEG_SRAM_RW_DATA, val);
		}

		for (j = 0; j < 64 - DIV_ROUND_UP(length, 4); j++)
			cedrus_write(dev, VE_DEC_MPEG_SRAM_RW_DATA, 0);
	}
}

static int cedrus_jpeg_setup(struct cedrus_ctx *ctx, struct cedrus_run *run)
{
	struct v4l2_jpeg_reference quantization_tables[4] = { };
	dma_addr_t src_buf_addr, dst_luma_addr, dst_chroma_addr;
	struct v4l2_jpeg_reference huffman_tables[4] = { };
	struct vb2_buffer *src_buf = &run->src->vb2_buf;
	struct v4l2_jpeg_scan_header scan_header;
	struct cedrus_dev *dev = ctx->dev;
	struct v4l2_jpeg_header header = {
		.scan = &scan_header,
		.quantization_tables = quantization_tables,
		.huffman_tables = huffman_tables,
	};
	unsigned long size;
	const u8 *matrix;
	u8 hmax, vmax;
	int ret, i;
	u32 reg;

	size = vb2_get_plane_payload(src_buf, 0);

	ret = v4l2_jpeg_parse_header(vb2_plane_vaddr(src_buf, 0), size, &header);
	if (ret < 0) {
		v4l2_err(&dev->v4l2_dev, "failed to parse JPEG header: %d\n", ret);
		return -EINVAL;
	}

	reg = header.frame.component[0].horizontal_sampling_factor << 20 |
		header.frame.component[0].vertical_sampling_factor << 16 |
		header.frame.component[1].horizontal_sampling_factor << 12 |
		header.frame.component[1].vertical_sampling_factor << 8 |
		header.frame.component[2].horizontal_sampling_factor << 4 |
		header.frame.component[2].vertical_sampling_factor;

	switch (reg) {
	case 0x221111:
		ctx->codec.jpeg.subsampling = VE_DEC_MPEG_TRIGGER_CHROMA_FMT_420;
		break;
	case 0x211111:
		ctx->codec.jpeg.subsampling = VE_DEC_MPEG_TRIGGER_CHROMA_FMT_422;
		break;
	case 0x111111:
		ctx->codec.jpeg.subsampling = VE_DEC_MPEG_TRIGGER_CHROMA_FMT_444;
		break;
	case 0x121111:
		ctx->codec.jpeg.subsampling = VE_DEC_MPEG_TRIGGER_CHROMA_FMT_422T;
		break;
	default:
		v4l2_err(&dev->v4l2_dev, "unsupported subsampling\n");
		return -EINVAL;
	}

	/* Activate JPEG engine. */
	cedrus_engine_enable(ctx);

	/* Set restart interval. */
	cedrus_write(dev, VE_DEC_MPEG_JPEG_RES_INT, header.restart_interval);

	/* Set intra quantisation matrix. */
	matrix = quantization_tables[header.frame.component[0].quantization_table_selector].start;
	for (i = 0; i < 64; i++) {
		reg = VE_DEC_MPEG_IQMINPUT_WEIGHT(i, matrix[i]);
		reg |= VE_DEC_MPEG_IQMINPUT_FLAG_INTRA;

		cedrus_write(dev, VE_DEC_MPEG_IQMINPUT, reg);
	}

	/* Set non-intra quantisation matrix. */
	matrix = quantization_tables[header.frame.component[1].quantization_table_selector].start;
	for (i = 0; i < 64; i++) {
		reg = VE_DEC_MPEG_IQMINPUT_WEIGHT(i, matrix[i]);
		reg |= VE_DEC_MPEG_IQMINPUT_FLAG_NON_INTRA;

		cedrus_write(dev, VE_DEC_MPEG_IQMINPUT, reg);
	}

	/* Set resolution in blocks. */
	hmax = header.frame.component[0].horizontal_sampling_factor;
	vmax = header.frame.component[0].vertical_sampling_factor;
	for (i = 1; i < 3; i++) {
		if (hmax < header.frame.component[i].horizontal_sampling_factor)
			hmax = header.frame.component[i].horizontal_sampling_factor;
		if (vmax < header.frame.component[i].vertical_sampling_factor)
			vmax = header.frame.component[i].vertical_sampling_factor;
	}

	reg = VE_DEC_MPEG_JPEG_SIZE_WIDTH(DIV_ROUND_UP(header.frame.width, 8 * hmax));
	reg |= VE_DEC_MPEG_JPEG_SIZE_HEIGHT(DIV_ROUND_UP(header.frame.height, 8 * vmax));
	cedrus_write(dev, VE_DEC_MPEG_JPEG_SIZE, reg);

	/* Disable rotation. */
	cedrus_write(dev, VE_DEC_MPEG_SD_ROT_DBLK_CTL, 0);

	/* Set Diffie-Huffman tables. */
	cedrus_write_dh_tables(dev, &header);

	/* Destination luma and chroma buffers. */

	dst_luma_addr = cedrus_dst_buf_addr(ctx, &run->dst->vb2_buf, 0);
	dst_chroma_addr = cedrus_dst_buf_addr(ctx, &run->dst->vb2_buf, 1);

	cedrus_write(dev, VE_DEC_MPEG_REC_LUMA, dst_luma_addr);
	cedrus_write(dev, VE_DEC_MPEG_REC_CHROMA, dst_chroma_addr);

	/* Source offset and length in bits. */

	cedrus_write(dev, VE_DEC_MPEG_VLD_OFFSET, 8 * header.ecs_offset);

	reg = size * 8;
	cedrus_write(dev, VE_DEC_MPEG_VLD_LEN, reg);

	/* Source beginning and end addresses. */

	src_buf_addr = vb2_dma_contig_plane_dma_addr(src_buf, 0);

	reg = VE_DEC_MPEG_VLD_ADDR_BASE(src_buf_addr);
	reg |= VE_DEC_MPEG_VLD_ADDR_VALID_PIC_DATA;
	reg |= VE_DEC_MPEG_VLD_ADDR_LAST_PIC_DATA;
	reg |= VE_DEC_MPEG_VLD_ADDR_FIRST_PIC_DATA;

	cedrus_write(dev, VE_DEC_MPEG_VLD_ADDR, reg);

	reg = src_buf_addr + size;
	cedrus_write(dev, VE_DEC_MPEG_VLD_END_ADDR, reg);

	/* Clear previous errors. */
	cedrus_write(dev, VE_DEC_MPEG_ERROR, 0);

	/* Enable appropriate interruptions and components. */

	reg = VE_DEC_MPEG_CTRL_IRQ_MASK | VE_DEC_MPEG_CTRL_MC_NO_WRITEBACK |
	      VE_DEC_MPEG_CTRL_MC_CACHE_EN;

	cedrus_write(dev, VE_DEC_MPEG_CTRL, reg);

	printk("Yay!\n");
	return 0;
}

static void cedrus_jpeg_trigger(struct cedrus_ctx *ctx)
{
	struct cedrus_dev *dev = ctx->dev;
	u32 reg;

	/* Trigger JPEG engine. */
	reg = VE_DEC_MPEG_TRIGGER_HW_JPEG_VLD | VE_DEC_MPEG_TRIGGER_JPEG;
	reg |= ctx->codec.jpeg.subsampling;

	cedrus_write(dev, VE_DEC_MPEG_TRIGGER, reg);
	printk("Trigger!\n");
}

struct cedrus_dec_ops cedrus_dec_ops_jpeg = {
	.irq_clear	= cedrus_jpeg_irq_clear,
	.irq_disable	= cedrus_jpeg_irq_disable,
	.irq_status	= cedrus_jpeg_irq_status,
	.setup		= cedrus_jpeg_setup,
	.trigger	= cedrus_jpeg_trigger,
};
